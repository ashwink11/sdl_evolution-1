# WiFi Transport: Sharing SSID and password with Mobile Proxy

* Proposal: [SDL-0245](0245-sharing-wifi-ssid-and-password.md)
* Author: [Ashwin Karemore](https://github.com/ashwink11)
* Status: **Returned for Revisions**
* Impacted Platforms: [Java Suite / iOS / RPC / Core / HMI]

## Introduction

This proposal defines supported WiFi modes for IVI and mobile devices. It also defines new RPCs to facilitate automatic network connection when supported secondary transport is WiFi.

## Motivation

In the current implementation of SDL over WiFi transport, IP address and port are shared with Mobile proxy. However, the prerequisite for using SDL over WiFi transport is that the mobile device should be connected to WiFi.
In some cases, entering a password for the access point created by HMI could be tedious and it would be a lot more convenient for users if devices could automatically connect via WiFi.

If WiFi credentials are automatically generated by the system, the password could contain special characters or it could be just too long. It would be inconvenient for the user to enter such passwords in HMI. Another possible scenario is, HMI could keep changing passwords to improve the security of the network. In such cases, a user might need to connect to the WiFi network every time the password is changed.

## Proposed solution

The available transport type for Secondary Transport can be configured through `smartDeviceLink.ini` file. 

SDL adapters could define supported WiFi modes in `smartDeviceLink.ini` file. The mobile proxy could use the defined RPC's below to share WiFi credentials and connect automatically with users' consent and least user interaction.  

If IVI supports WiFi Access Point mode, the Android and iOS provide APIs to connect to a WiFi network in case WiFi SSID and password is known. These APIs could be used in Mobile Proxy to connect to the WiFi access point created by HMI. The flow for the proposed solution would be:

`HMI creates WiFi Access Point --> HMI provides WiFi Access point credentials to SDL Core --> SDL Core shares WiFi credentials using Primary Transport --> Mobile Proxy receives WiFi access point credentials  --> Mobile Proxy automatically connects to the WiFi access point.`

### Define Supported WiFi Modes

As defined in a proposal [SDL-0141](https://github.com/smartdevicelink/sdl_evolution/blob/13031dfe6d17c20fdbc673b4ac0016992d765fcd/proposals/0141-multiple-transports.md), the available secondary transport is communicated to mobile proxy using protocol message `Start Service Ack`. To communicate supported WiFi modes the supported transport list needs to be updated for possible Wi-Fi modes. 

**Table 1: list of transport type strings**

String                 | Description
-----------------------|------------
IAP\_BLUETOOTH         | iAP over Bluetooth
IAP\_USB               | iAP over USB, and Core cannot distinguish between Host Mode and Device Mode.
IAP\_USB\_HOST\_MODE   | iAP over USB, and the phone is running as host
IAP\_USB\_DEVICE\_MODE | iAP over USB, and the phone is running as device
IAP\_CARPLAY           | iAP over Carplay wireless
SPP\_BLUETOOTH         | Bluetooth SPP. Either legacy SPP or SPP multiplexing.
AOA\_USB               | Android Open Accessory
TCP\_WIFI\_AP\_MODE    | TCP connection over Wi-Fi and the phone is WiFi Access point.
TCP\_WIFI\_STA\_MODE   | TCP connection over Wi-Fi and the phone connects using WiFi Station mode.

Here is an example of parameters in the Start Service ACK frame:

```json
{
  .
  .
  "secondaryTransports": ["TCP_WIFI_STA_MODE"],
}
```

The core will know the supported secondary transport based on values in `smartdevicelink.ini` file. The possible values for the supported secondary transport value need to be updated. `WiFi_AP_MODE` and `WiFi_STA_MODE` are added below by replacing `WiFi` value. The SDL core will use these values to communicate supported secondary transport using protocol message `Start Service Ack`.

The SDL adapters can define desired supported secondary transports in `smartdevicelink.ini` file as shown below.

```
; Comma-separated list of transports that can be used as Secondary Transport for each Primary Transport.
; Possible values are: WiFi_AP_MODE, WiFi_STA_MODE, USB and Bluetooth.
; Core will not suggest Secondary Transport if the value is empty.
SecondaryTransportForBluetooth = WiFi_STA_MODE
SecondaryTransportForUSB =
SecondaryTransportForWiFi =
```

Here is an example of the Service map after defining supported secondary transport.

```
[ServicesMap]
; A matrix to specify which service is allowed on which transports. The transports are listed
; in preferred order. If a transport is not listed, then the service is not allowed
; to run on the transport.
; Only video and audio services are configurable.
; If the entry of a service is completely omitted, the service will be allowed on all transports.
; Possible values are: IAP_BLUETOOTH, IAP_USB, IAP_USB_HOST_MODE, IAP_USB_DEVICE_MODE, IAP_CARPLAY, SPP_BLUETOOTH, AOA_USB, TCP_WIFI_AP_MODE and TCP_WIFI_STA_MODE.
; Note: this configuration is applied even if multiple-transports feature is not enabled.
; Audio service
0x0A = TCP_WIFI_STA_MODE, IAP_CARPLAY, IAP_USB_HOST_MODE, IAP_USB_DEVICE_MODE, IAP_USB, AOA_USB
; Video service
0x0B = TCP_WIFI_STA_MODE, IAP_CARPLAY, IAP_USB_HOST_MODE, IAP_USB_DEVICE_MODE, IAP_USB, AOA_USB
```

### HMI API changes

1. Device Info is changed to provide WiFi auto-connect feature support information to IVI. IVI will receive `DeviceInfo.wifiConfigurationInfo` in `OnAppRegistered` HMI API when the app is registered using `primary transport`. 
2. HMI can send `OnSystemRequest` notification with `RequestType` as `WIFI_CONNECTION_REQ` to inform app to try connecting WiFi. This notification will be sent only when a user has provided consent to share WiFi credentials, and the connected app supports WiFi auto-connect and the user attempts to launch that app.
3. HMI will not send `OnSystemRequest` notification with `RequestType` as `WIFI_CONNECTION_REQ` if app is already connected using WiFi.
4. If IVI is a WiFi Access point, the HMI will notify SDL Core using `OnWiFiTransportStatusUpdate` whenever the WiFi state is changed.
5. If IVI is connecting in WiFi station mode and the SDL app supports WiFi auto-connect, the mobile proxy can send `JoinWiFiNetwork` RPC to IVI to share mobile device's WiFi access point credentials. 

```xml
<interface name="Common" version="X.X.X" date="2019-XX-XX">
<struct name="DeviceInfo" since="X.X">
  .
  .
  .
  <param name="wifiConfigurationInfo" type="WiFiConfigurationInfo" mandatory="false">
      <description>Device's available configurations around WiFi networking</description>
  </param>      
</struct> 

<struct name="WiFiConfigurationInfo" since="x.x">
    <description>Describes some of the sending device's available configurations around WiFi networking. This includes the ability to automatically join a network or host one itself.</description>
    <param name="autoJoinWiFiSupported" type="Boolean" mandatory="false">
        <description> </description>
    </param>
    <param name="canHostWiFiNetwork" type="Boolean" mandatory="false">
        <description> </description>
    </param> 
</struct>

<enum name="RequestType">
  .
  .
  .
  <element name="WIFI_CONNECTION_REQ" />
</enum>
</interface>

<interface name="BasicCommunication" version="X.X.X" date="2019-XX-XX">
	.
	.
	.
  <function name="JoinWiFiNetwork" messagetype="request">
    <description>A request from the connected device to join the specified WiFi network.</description>
    <param name="wifiState" type="WiFiStateInfo" mandatory="false">
        <description>wifi state info</description>
    </param>
    <param name="ssid" type="String" minlength="1" maxlength="32" mandatory="false">
        <description>name of the WiFi ssid</description>
    </param>
    <param name="password" type="String" minlength="1" maxlength="100" mandatory="false">
        <description>password to use to connect AP</description>
    </param>
    <param name="securityType" type="WiFiSecurityType" mandatory="false">
        <description>security type of WiFi AP</description>
    </param>   
</function>

<function name="JoinWiFiNetwork" messagetype="response">
</function>

<function name="OnWiFiAPTransportStatus" messagetype="notification">
  <description>IVI in WiFi access point mode, notify SDL about WiFi Access point status.</description>
	    <param name="ssid" type="String" minlength="1" maxlength="32" mandatory="false">
        <description>name of the WiFi ssid</description>
      </param>
	    <param name="password" type="String" minlength="1" maxlength="100" mandatory="false">
        <description>password to use to connect AP</description>
      </param>
	    <param name="securityType" type="WiFiSecurityType" mandatory="false">
        <description>security type of WiFi AP</description>
      </param>
      <param name="wifiState" type="WiFiStateInfo" mandatory="false">
        <description>wifi state info</description>
      </param>
  </function>
</interface>
```

Enum to define the WiFi state and WiFi security type.

```xml
<enum name="WiFiSecurityType">
  <description>enum to define WiFi security types used for WiFi connection.</description>
  <element name="WIFI_SECURITY_NONE"/>
  <element name="WIFI_SECURITY_WEP"/>
  <element name="WIFI_SECURITY_WPA"/>
  <element name="WIFI_SECURITY_WPA2 "/>
</enum>

<enum name="WiFiStateInfo">
  <description>enum to define WiFi state.</description>
  <element name="WIFI_STATE_DISABLED"/>
  <element name="WIFI_STATE_ENABLED"/>
</enum>
```

### Mobile API changes

1. The proxy should send `DeviceInfo.wifiConfigurationInfo` information along with `RegisterAppInterface` request. If the mobile device supports WiFi transport APIs provided by platform and app developer configured ON WiFi auto-connect features, then proxy should send `DeviceInfo.wifiConfigurationInfo` with appropriate values.
2. If IVI is a WiFi access point, the proxy did not receive WiFi credentials using `GetWiFiNetworkInfo` due to some error, the proxy should request credentials again using `GetWiFiNetworkInfo` only after receiving `Transport Event Update` protocol message with a valid IP address. 
3. If IVI is the WiFi access point, the proxy will receive `Transport Event Update` with an empty IP address when TCP transport is unavailable. The proxy will not try connecting WiFi if `Transport Event Update` with an empty IP address is received. 
4. The proxy and IVI should try establishing a WiFi connection only when Driver Distraction is OFF.
5. The proxy should try to create WiFi AP or get WiFi AP credentials using below RPCs as soon as possible upon receiving `OnSystemRequest` notification with `WIFI_CONNECTION_REQ` request type. 
6. The policy table should be updated to include the below-mentioned RPCs. These RPCs should be updated in a separate `functional group`, so that, if required, the user can specifically disable WiFi credentials and status sharing RPCs with their app while allowing other RPCs. OEMs, if they require, can enable the RPC message protection feature for the below-mentioned Mobile APIs.
7. SDL Core should check the policy table and user consent for the below-mentioned Mobile APIs. 

```xml
<enum name="FunctionID" internal_scope="base" since="1.0">
  .
  .
  .
  <element name="GetWiFiNetworkInfoID" value="XX" hexvalue="XX" since="X.X" />
  <element name="JoinWiFiNetworkID" value="XX" hexvalue="XX" since="X.X" />
</enum>

<enum name="RequestType">
  .
  .
  .
  <element name="WIFI_CONNECTION_REQ" />
</enum>

<struct name="DeviceInfo" since="X.X">
  .
  .
  .
  <param name="wifiConfigurationInfo" type="WiFiConfigurationInfo" mandatory="false">
      <description>Device's available configurations around WiFi networking</description>
  </param>      
</struct> 

<struct name="WiFiConfigurationInfo" since="x.x">
    <description>Describes some of the sending device's available configurations around WiFi networking. This includes the ability to automatically join a network or host one itself.</description>
    <param name="autoJoinWiFiSupported" type="Boolean" mandatory="false">
        <description> </description>
    </param>
    <param name="canHostWiFiNetwork" type="Boolean" mandatory="false">
        <description> </description>
    </param> 
</struct>

<enum name="WiFiStateInfo">
  <description>enum to define WiFi state.</description>
  <element name="WIFI_STATE_DISABLED"/>
  <element name="WIFI_STATE_ENABLED"/>
</enum>

<enum name="WiFiSecurityType">
  <description>enum to define WiFi security types used for WiFi connection.</description>
  <element name="WIFI_SECURITY_NONE">
    <description>No security protocol used.</description>
  </element>
  <element name="WIFI_SECURITY_WEP">
      <description>WEP security protocol should be used. </description>
  </element>
  <element name="WIFI_SECURITY_WPA">
      <description>WPA security protocol should be used.</description>
  </element>
  <element name="WIFI_SECURITY_WPA2 ">
      <description>WPA2 security protocol should be used.</description>
  </element>
</enum>

<function name="GetWiFiNetworkInfo" functionID="GetWiFiNetworkInfoID" messagetype="request" since="X.X">
  <description>RPC sent by proxy to request WiFi status info from SDL Core.</description>
</function>

<function name="GetWiFiNetworkInfo" functionID="GetWiFiNetworkInfoID" messagetype="response" since="X.X">
  <param name="success" type="Boolean" platform="documentation" mandatory="true">
    <description> true, if successful; false, if failed </description>
  </param>
        
  <param name="resultCode" type="Result" platform="documentation" mandatory="true">
    <description>See Result</description>
    <element name="SUCCESS"/>
    <element name="UNSUPPORTED_RESOURCE">
    <element name="DISALLOWED"/>
    <element name="REJECTED">
    <element name="TOO_MANY_PENDING_REQUESTS"/>
    <element name="APPLICATION_NOT_REGISTERED"/>
    <element name="GENERIC_ERROR"/>
    <element name="USER_DISALLOWED"/>
    <element name="DATA_NOT_AVAILABLE"/>
  </param>
        
  <param name="info" type="String" maxlength="1000" mandatory="false" platform="documentation">
    <description>Provides additional human readable info regarding the result.</description>
  </param> 
  <param name="wifiState" type="WiFiStateInfo" mandatory="false">
    <description>wifi state info</description>
  </param>
  <param name="ssid" type="String" minlength="1" maxlength="32" mandatory="false">
      <description>name of the WiFi ssid</description>
  </param>
	<param name="password" type="String" minlength="1" maxlength="100" mandatory="false">
    <description>password to use to connect AP</description>
  </param>
	<param name="securityType" type="WiFiSecurityType" mandatory="false">
    <description>security type of WiFi AP</description>
  </param>   
</function>

<function name="JoinWiFiNetwork" functionID="JoinWiFiNetworkID" messagetype="request" since="X.X">
    <description>A request for the receiver to join the specified network.</description>
    <param name="wifiState" type="WiFiStateInfo" mandatory="false">
        <description>wifi state info</description>
    </param>
    <param name="ssid" type="String" minlength="1" maxlength="32" mandatory="false">
        <description>name of the WiFi ssid</description>
    </param>
    <param name="password" type="String" minlength="1" maxlength="100" mandatory="false">
        <description>password to use to connect AP</description>
    </param>
    <param name="securityType" type="WiFiSecurityType" mandatory="false">
        <description>security type of WiFi AP</description>
    </param>   
</function>

<function name="JoinWiFiNetwork" functionID="JoinWiFiNetworkID" messagetype="response" since="X.X">
    <description>A response and description of requested action.</description>
  <param name="success" type="Boolean" platform="documentation" mandatory="true">
    <description> true, if successful; false, if failed </description>
  </param>
        
  <param name="resultCode" type="Result" platform="documentation" mandatory="true">
    <description>See Result</description>
    <element name="SUCCESS"/>
    <element name="UNSUPPORTED_RESOURCE">
    <element name="DISALLOWED"/>
    <element name="REJECTED">
    <element name="TOO_MANY_PENDING_REQUESTS"/>
    <element name="APPLICATION_NOT_REGISTERED"/>
    <element name="GENERIC_ERROR"/>
    <element name="USER_DISALLOWED"/>
    <element name="DATA_NOT_AVAILABLE"/>
  </param>
        
  <param name="info" type="String" maxlength="1000" mandatory="false" platform="documentation">
    <description>Provides additional human readable info regarding the result.</description>
  </param>   
</function>
```

Possible responses for the above mentioned RPCs.

1. RPC response will be `SUCCESS` if the request is successful.
2. RPC response will be `UNSUPPORTED_RESOURCE` if HMI does not support WiFi transport for SDL. The SDL Core will also send this result code in the following scenarios:
  >* If `JoinWiFiNetwork` RPC is used, when supported secondary transport received in `Start Service Ack` is only `TCP_WiFi_STA_Mode`.
  >* If `GetWiFiNetworkInfo` RPC is used, when supported secondary transport received in `Start Service Ack`  is only `TCP_WiFi_AP_Mode`.
3. RPC response will be `DISALLOWED` if RPC is not authorized in the local policy table.
4. RPC response will be `GENERIC_ERROR` if the request cannot be processed due to some internal error.
5. RPC response will be `USER_DISALLOWED` if user disabled WiFi status info sharing with the app.
6. RPC response will be `DATA_NOT_AVAILABLE` if WiFi status info is not available with SDL Core. 

## Potential downsides

Apps need to include additional permissions to use WiFi APIs. However, it would provide convenience to users if Apps can connect to HMI automatically instead of the manual process and thus outweighs the mentioned downside.

## Impact on existing code

### Changes in SDL Core

1. Implementation of HMI API described above in Core. 
2. Implementation of Mobile API described above in SDL Core.
3. Implementation to handle additional `functional group` for WiFi.
4. If IVI is a WiFi access point, the SDL Core will cache `WiFi credentials` received from HMI and will be able to share them with other apps if permitted by policies.
5. If a mobile device is a WiFi access point, the SDL Core will not cache `WiFi credentials` received from a mobile device. 

### Policy Changes

1. The policy table needs to be updated for the new Mobile API.
2. The new functional group should be created so that, if required, the user can explicitly disable the sharing of WiFi info.

### Proxy Changes

1. The proxy needs to implement the Mobile API mentioned above.
2. The mobile device and IVI can connect via Wi-Fi using platform APIs provided SSID, password, and security type are known. However, these APIs need special permissions or entitlements. App developers can choose if they want to provide these permissions or not. Hence, app developers should be able to configure OFF WiFi auto-connect feature using proxy API. The proxy will provide an API to app developers to configure ON/OFF WiFi auto-connect features. If app developers use this API to configure ON WiFi auto-connection features, the proxy should use the below mentioned RPC's to request Wi-Fi credentials or send Wi-Fi credentials to IVI. If app developers use this API to configure OFF WiFi auto-connection, the proxy should not request or provide WiFi credentials to IVI.

    Here is an example of the WiFi configuration APIs to enable/disable WiFi auto-connect features in Android proxy.

```
/** API to make mobile device as WiFi access point*/
MultiplexTransportConfig.setCanHostWiFiNetwork(Boolean);

/** API to automatically connect WiFi access point created by IVI*/
MultiplexTransportConfig.setCanAutoJoinWiFiNetwork(Boolean);

```
3. The proxy should be able to check the mobile device OS version. In case platform API support to connect WiFi is not available in a mobile device, the proxy should be able to configure OFF WiFi auto-connect features at run time.
4. The proxy should set `DeviceInfo.wifiConfigurationInfo` with appropriate values set by app developers. For example:

>* If `MultiplexTransportConfig.setCanHostWiFiNetwork( true )` and mobile device __DOES__ supports WiFi transport APIs then `DeviceInfo.wifiConfigurationInfo.canHostWiFiNetwork = true `
---
>* If `MultiplexTransportConfig.setCanAutoJoinWiFiNetwork( true )` and mobile device __DOES__ supports WiFi transport APIs then `DeviceInfo.wifiConfigurationInfo.canAutoJoinWiFiNetwork = true`

5. The proxy should set `DeviceInfo.wifiConfigurationInfo` values to `false`, either if the WiFi auto-connect is configured OFF by app developer or mobile device does not support platform API to connect WiFi. For example:


>* If `MultiplexTransportConfig.setCanHostWiFiNetwork( true )` and mobile device __DOES NOT__ supports WiFi transport APIs then `DeviceInfo.wifiConfigurationInfo.canHostWiFiNetwork = false`
---
>* If `MultiplexTransportConfig.setCanAutoJoinWiFiNetwork( true )` and mobile device __DOES NOT__ supports WiFi transport APIs then `DeviceInfo.wifiConfigurationInfo.canAutoJoinWiFiNetwork = false`
---
>* If `MultiplexTransportConfig.setCanHostWiFiNetwork( false )` and mobile device __DOES__ supports WiFi transport APIs then `DeviceInfo.wifiConfigurationInfo.canHostWiFiNetwork = false`
---
>* If `MultiplexTransportConfig.setCanAutoJoinWiFiNetwork( false )` and mobile device __DOES__ supports WiFi transport APIs then `DeviceInfo.wifiConfigurationInfo.canAutoJoinWiFiNetwork= false`

6. The proxy should use the above mentioned mobile APIs for WiFi if corresponding `DeviceInfo.wifiConfigurationInfo` is set.

>* If `DeviceInfo.wifiConfigurationInfo.canHostWiFiNetwork = true` and supported secondary transport received in `Start Service Ack` protocol message is `TCP_WiFi_AP_Mode` only then the proxy can use `JoinWiFiNetwork` RPC.
---
>* If `DeviceInfo.wifiConfigurationInfo.canAutoJoinWiFiNetwork = true` and supported secondary transport received in `Start Service Ack` protocol message is `TCP_WiFi_STA_Mode` only then the proxy can use `GetWiFiNetworkInfo` RPC.

7. If app developers use this API to enable WiFi auto-connection feature, they should provide below permissions/entitlements:
>*  Android App will need to include WiFi permissions.
>*  iOS App will need to add `Hotspot Configuration` Capability.
8. The proxy should request WiFi status information using the above-mentioned API only if WiFi auto-connection is enabled by the app developer, the mobile device supports platform API to connect WiFi, and WiFi is supported as `secondary transport`.
9. The proxy should rely on error callbacks and return values to know whether WiFi connection using platform APIs was successful or failed. 

### Sample Code for WiFi Connection in Android

The below code can be used to connect to the WiFi Access point if SSID, password and security type are known.

```Java
    private void connectToWiFi(String ssid,String password){
        WifiConfiguration conf = new WifiConfiguration();
        conf.SSID = "\"" + ssid + "\"";
        conf.preSharedKey = "\""+ password +"\"";

        m_wifiManager.addNetwork(conf);
        List<WifiConfiguration> list = m_wifiManager.getConfiguredNetworks();
        for( WifiConfiguration i : list ) {
            if(i.SSID != null && i.SSID.equals("\"" + ssid + "\"")) {
                m_wifiManager.disconnect();
                m_wifiManager.enableNetwork(i.networkId, true);
                m_wifiManager.reconnect();
                break;
            }
        }
    }
```
Permissions required to use above mentioned API's are as follows:

```xml
<uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
<uses-permission android:name="android.permission.CHANGE_WIFI_STATE" />
```
### Sample Code for WiFi Connection in iOS

The below code can be used to connect to the WiFi Access point if SSID, password and security type are known.

```objc
    NEHotspotConfiguration * config = [[NEHotspotConfiguration alloc] initWithSSID:ssid passphrase:password isWEP:NO];
    [config setJoinOnce:NO];
    
    NEHotspotConfigurationManager* configManager = [NEHotspotConfigurationManager sharedManager];
    [configManager applyConfiguration:config completionHandler:^(NSError * _Nullable error) {
        [self showAlert:[error localizedDescription]];
        NSLog(@"Error %@",[error debugDescription]);
    }];
```
Capabilities required to use above mentioned APIs are as follows:

```
Hotspot Configuration
```

#### Steps to enable entitlements for iOS App

The app needs to request entitlements to use iOS APIs to connect to WiFi. The app developers can follow the below link to include these entitlements. 

* Apple developer/enterprise account needed to add required entitlement in the provisioning profile.
* Request required entitlements for your project. More info can be found in the below links.
  https://developer.apple.com/documentation/bundleresources/entitlements/com_apple_developer_networking_hotspotconfiguration
* Add capability to XCode target    
  https://help.apple.com/xcode/mac/current/#/dev88ff319e7
  
  These steps will be added to the SDLC Application Certification Guidelines as well.

### Recommended use case flow

The use cases defined are applicable only for video streaming apps. These use case recommendations are made considering the following pre-conditions:

1. HMI allows app registration of all apps using `primary transport`.
2. HMI does not allow video streaming apps to use cases using `primary transport`.
3. The mobile device supports WiFi connection APIs and app developer enabled WiFi auto-connect using APIs provided by a proxy. The values for `DeviceInfo.wifiConfigurationInfo` are appropriately set as defined above.
4. The supported secondary transport defined in `smartDeviceLink.ini` file is WiFi.

#### **A. `WiFi` credentials cannot be shared between App and IVI**

This case is applicable when the policy table is not updated or the user disallowed it.

#### Scenario Description
1. The proxy uses WiFi mobile APIs defined above.
2. SDL Core responds with `DISALLOWED` if the policy table is not updated.
3. The user tries to launch the app on HMI.
4. HMI shows "Waiting for Permission updates" pop-up with a timeout of 5 seconds.

##### Post Conditions 

WiFi credentials will not be shared between App and IVI.

#### **B. Policy table updated and user consent needed**

This case is applicable when the policy table is updated and the user did not provide consent to share WiFi credentials.

##### Scenario Description
1. If the proxy uses WiFi mobile APIs defined above before user consent, SDL Core responds with `DISALLOWED`.
2. The user tries to launch the app on HMI.
3. HMI determines that WiFi auto-connect is supported using `DeviceInfo.wifiConfigurationInfo`.
4. HMI requests `GetListOfPermissions` and determines if `WiFi group` permissions needed.
5. HMI requests user consent to share WiFi credentials with the app and informs the user that credentials can be used the app or IVI to join the WiFi network automatically.
6. The user provides consent to share WiFi credentials with the app or IVI. 
7. The IVI shows `Waiting for WiFi Connection. Please check your device when it is safe to do so. Apps on some devices may need your permissions to join WiFi network.` pop-up with a timeout of 5 seconds.

##### Post Conditions 

1. The proxy receives `OnPermissionChange` notification. As soon as this notification is received, the proxy uses WiFi mobile APIs to share WiFi credentials.
2. HMI sends `OnSystemRequest` notification with `WIFI_CONNECTION_REQ` request type. On receiving `OnSystemRequest` notification with `WIFI_CONNECTION_REQ` request type, the proxy should use mobile APIs for wifi to get or share wifi credentials.

##### Exceptions

##### **Exception 1: Consent to share WiFi credentials not provided**

User did not provide consent to share WiFi credentials

1. The user tries to launch the app on HMI.
2. HMI requests `GetListOfPermissions` and determines if `WiFi group` permissions needed.
3. HMI requests user consent to share WiFi credentials and informs the user that credentials can be used to join the WiFi network automatically.
4. The user did not provide consent to share WiFi credentials between the app and IVI.
5. HMI shows `Connect WiFi to use this App` pop-up with a timeout of 5 seconds.

##### **Exception 2: HMI pop-up `Waiting for WiFi Connection` timeouts**

This case would arise if the WiFi RPCs fail for any reason.

1. The user tries to launch the app on HMI.
2. HMI shows `Connect WiFi to use this App` pop-up with a timeout of 5 seconds.

#### **C. Policy table updated and user consent provided**

This case is applicable when the policy table is updated and the user has provided consent to share WiFi credentials.

##### Scenario Description
1. The user tries to launch the app on HMI.
2. HMI sends `OnSystemRequest` notification with `WIFI_CONNECTION_REQ` request type.
3. HMI shows `Waiting for WiFi Connection. Please check your device when it is safe to do so. Some devices may need your permissions to connect Car WiFi.` pop-up with a timeout of 5 seconds.
4. If IVI is a WiFi access point, the proxy use `GetWiFiNetworkInfo` RPC to requests WiFi status info, the SDL Core responds with `SUCCESS` and provides WiFi credentials to the app.
5. If the mobile device is a WiFi access point, the proxy use `JoinWiFiNetwork` RPC to share WiFi status info with the IVI, the SDL Core will forward WiFi info using HMI API `JoinWiFiNetwork` to HMI and receive result code. The SDL Core responds with `SUCCESS` on a successful WiFi connection.

##### Post Conditions 

1. WiFi credentials shared with the app.
2. The proxy connects to WiFi using credentials provided by HMI.

##### Exceptions

##### **Exception 1: HMI pop-up `Waiting for WiFi Connection` timeouts**

This case would arise if the WiFi connection APIs fail for any reason.

1. The user tries to launch the app on HMI.
2. HMI shows `Connect WiFi to use this App` pop-up with a timeout of 5 seconds.

#### **D. Driver distraction is ON**

This case is applicable when driver distraction is ON.

##### Scenario Description

1. The user tries to launch the app on HMI.
2. HMI shows `Connect WiFi to use this App` pop-up with a timeout of 5 seconds.

##### Post Conditions 

1. The user manually connects WiFi to use the app.

#### **E. WiFi auto-connect feature not enabled for app**

This case is applicable when the mobile device does not support WiFi connection APIs or the app developer configures it OFF.

##### Scenario Description

1. The user tries to launch the app on HMI.
2. HMI shows `Connect WiFi to use this App` pop-up with a timeout of 5 seconds.

##### Post Conditions 

1. The user manually connects WiFi to use the app.

#### Additional Queries if IVI is a WiFi access point

1. Should mobile receive Wifi credentials if it is already connected by Wifi transport?
- Yes, the proxy will receive WiFi status notifications even when it is connected to WiFi. This would help in cases when WiFi is disabled and enabled again due to some reasons. The proxy can retry connecting using credentials available.

2. If new application request WiFi updates, should it immediately receive cached WiFi credentials?
- Yes, if allowed by policy, the new app should receive cached WiFi credentials.

3. Should cached Wifi credentials be stored on SDL storage across ignition cycles?
- No. HMI should always update SDL Core about WiFi status changes using `OnWiFiTransportStatusUpdate` HMI API. 

## Alternatives considered

1. The proxy can know the status of the current WiFi connection using APIs provided in Android and iOS SDK. However, these APIs require additional permissions and entitlements. 

2. Instead of depending on `Transport Event Update` to know the WiFi connection state, `subscription` methods could be provided in mobile API, as defined below. However, this would increase the number of available RPCs for WiFi.